---
title: 数据库系统原理 - 数据库编程
date: 2018-09-04 20:10:52
tags:
categories:
    - 考试
    - 数据库系统原理
---
# 第五章 - 数据库编程

## 存储过程

### 存储过程的基本概念

**存储过程** 是一组为了完成某项特定功能的 **SQL语句集** 其实质就是一段存储在数据库中的代码 它可以由声明示的SQL语句和过程式的SQL语句组成。
<!-- more -->

1. 可增强SQL语言的功能和灵活性
2. 良好的封装性
3. 高性能
4. 可减少网络流量
5. 可作为一种安全机制来确保数据库的安全性和数据完整性

### 创建存储过程

**DELIMITER** 命令
语法: 修改语句结束标识
```
DELIMITER $$(用户指定的标识)
```

**使用CREATE PROCEDURE 语句创建存储过程**
```
CREATE PROCEDURE sp_name([proc_parameter[,...]])
    routine_body
```

**proc_parameter** 存储过程参数列表
**routine_body** 存储过程体

[in|out|inout]param_name type

栗子:
```
DELIMITER $$
CREATE PROCEDURE sp_update_sex(IN cid INT, IN csex CHAR(1))
BEGIN
    UPDATE customers SET cust_sex = csex WHERE cust_id = cid;
END$$
```

### 存储过程体
**使用DELCEAR语句声明局部变量**
```
DECLEAR var_name[...] type [DEFAULT value]
```

栗子:
```
DECLEARE cid INT(10);
```

1. 只能在存储过程体的BEGIN...END语句块中声明
2. 必须在存储过程的开头处声明
3. 作用范围仅限于声明它的BEGIN...EBD语句块
4. 不同于用户变量

局部变量于用户变量的区别：

1. 局部变量声明时，在其前面没有@符号，并且它只能被声明它的BEGIN...END语句块中的语句所使用
2. 用户变量在声明时，会在其名称前面使用@符号，同时已声明的用户变量存在于整个会话之中。

**使用SET语句为局部变量赋值**
```
SET var_name = expr[, var_name=expr]...
```

栗子:
```
SET cid = 910;
```

**使用SELECT INTO 语句把选定列的值直接存储到局部变量中**
```
SELECT col_name[...] INTO var_name[...] table_expr
```
col_name-指定列名

var_name-指定要赋值的变量名

table_expr-表示SELECT语句中的FROM子句及后面的语法部分

栗子：
```
SELECT cust_id INTO cid customers WHERE cust_name = '哇哈哈'；
```

**流程控制语句**
1. 条件判断语句
   > IF...THEN ...ELSE语句

   > CASE语句
2. 循环语句
   > WHILE语句

   > REPEAT语句

   > LOOP 语句

**LTERATE语句** 用于表示退出当前循环

**使用DECLARE CURSOR语句创建游标**
```
DECLARE cursor_name CURSOR FOR select_statement
```

**使用 OPEN 语句打开游标**
```
OPEN cursor_name
```
cursor_name -> 指定要打开的游标

**使用FETCH...INTO语句读取数据**
```
FETCH cursor_name INTO var_name[var_name]...
```
cursor_name -> 指定已打开的游标

var_name -> 指定存放数据的变量名

**使用CLOSE 语句关闭游标**
```
CLOSE cursor_name
```
### 调用存储过程

**使用CALL语句调用存储过程**
```
CALL sp_name([parameter[,...]])
call sp_name[()]
```
栗子:
```
call sp_update_sex(3,'m');
```
### 删除存储过程
**使用DROP PROCEDURE 语句删除存储过程**

```
DROP PROCEDURE [IF EXISTS] sp_name
```

## 存储函数

## 什么是存储函数

存储函数与存储过程一样，是由SQL语句和过程式语句组成的代码片段

|存储函数|存储过程|
|--|--|
|不能拥有输出参数|可以拥有输出函数|
|可以直接调用存储函数|需要 CALL 语句调用存储过程|
|必须包含一条RETURN语句|不允许包含RETURN语句|

## 创建存储函数

**使用CREATE FUNCTION语句创建存储函数**

```
 CREATE FUNCTION sp_name([func_parameter[,...]])
    RETURNS type 
    routine_body
```
RETURNS type 声明存储函数返回值的数据类型；type指定返回值的数据类型

```
DELIMITER $$
CREATE FUNCTION fn_search(cid INT) 
    RETURNS CHAR(10) 
    DETERMINISTIC 
BEGIN
    DECLARE SEX CHAR(10);
    SELECT cust_sex INTO SEX FROM customers WHERE cust_id = cid;
    IF SEX IS NULL THEN
        RETURN(SELECT '没有该客户');
    ELSE IF SEX = 'f' THEN
        RETURN(SELECT '女');
    ELSE RETURN(SELECT '男');
    END IF
    ;
    END IF;
END $$
```
## 调用存储函数

**使用关键字SELECT 调用存储函数**
```
SELECT sp_name([func_parameter[,...]])
```

## 删除存储函数

**使用DROP FUNCTION**语句删除存储函数
```
DROP FUNCTION [IF EXISTS] sp_name;
```