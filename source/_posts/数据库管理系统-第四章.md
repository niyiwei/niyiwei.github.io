---
title: 数据库系统原理 - SQL与关系数据库基本操作
date: 2018-08-27 20:30:02
tags:
categories:
    - 考试
    - 数据库系统原理
---
# 第四章 - SQL与关系数据库基本操作

## SQL概述

### 什么是SQL

**结构化查询语言** （Structured Query Language，SQL）是专门用来与数据库通信的语言，它可以帮助用户操作关系数据库

<!-- more -->

### SQL的特点

+ SQL不是某个特定数据库供应商专用的语言
+ SQL简单易学
+ SQL强大、灵活，可以进行非常复杂和高级的数据库操作

### SQL的组成

+ 数据查询
+ 数据定义
+ 数据操纵
+ 数据控制

**数据定义语言（Date Definition Language，DDL）**

+ CREATE 创建数据库或数据库对象
+ ALTER 对数据库或数据库对象进行修改
+ DROP 删除数据库或数据库对象

**数据库操纵语言（Date Manipulation Language，DML）**

+ SELECT 从表或视图中检索数据
+ INSERT 将数据插入到表或视图中
+ UPDATE 修改表或视图中的数据
+ DELETE 从表或视图中删除数据

**数据控制语言（Data Control Language，DCL）**

+ GRANT 用于授予权限
+ REVOKE 用于收回权限

**嵌入式和动态SQL规则**

规定SQL语句在高级程序设计语言中使用的规范方法，以便适应较为复杂的应用

**SQL调用和会话规则**

SQL调用包括SQL例程和调用规则，以便提高SQL的灵活性、有效性、共享性以及使SQL具有更多的高级语言的特征；

SQL会话规则可使应用程序连接到多个SQL的服务器中的某一个，并与之交互。

## MySQL预备知识

### MySQL使用基础

关系数据库管理系统（ **RDBMS** ）

- LAMP - （Linux Apache MySQL PHP/Perl/Python）
- WAMP -  (Windows Apache MySQL PHP/Perl/Python)

###  MySQL扩展语言要素

+ 常量
    + 字符串常量（也称字面值或标量值）

        用单引号或双引号括起来的字符序列，分为ASCLL字符串常量和Unicode字符串常量

    + 数值常量
        + 整数常量
        + 浮点数常量
    + 十六进制常量（每对十六进制数字被转换为一个字符，其最前面有一个字母'X'或“x”）
    + 时间日期常量（用单引号讲表示日期时间的字符串括起来而构成的）
    + 位字段值 格式：b'value' -> 二进制值
    + 布尔值 TURE -> 1, FALSE -> 0
    + NULL值
+ 变量
    + 用户变量
        用户变量前常添加一个符号@，用于将其与列名区分开

    + 系统变量
        大多数系统变量应用于其他SQL语句中时，必须在系统变量前添加两个@
+ 运算符
    + 算数运算符：+（加），-（减），*（乘），/（除），%（求模）
    + 位运算符：&（位于），|（位或），^（位异或），~（位取反），>>（位右移），<<（位左移）
    + 比较运算符：=，<，>，>=，<=，<>，!=，<=>
    + 逻辑运算符：NOT或！（逻辑非），AND或%%（逻辑与），OR或||（逻辑或），XOR（逻辑异常）
+ 表达式

    表达式是常量、变量、列名、复杂计算、运算符和函数的组合

+ 内置函数
    + 数学函数
    + 聚合函数
    + 字符串函数
    + 日期和时间函数
    + 加密函数
    + 控制流程函数
    + 格式化函数
    + 类型转换函数
    + 系统信息函数
### 

## 数据定义

### 数据库模式定义

####创建数据库
使用 **CRESTE DATABASE** 或 **CREATE SCHEMA** 语句

语法：
```
    CREATE {DATABASE | SCHEMA} [IF NOT EXISTS] db_name
    [DEFAULT] CHARACTER SET[=]charset_name
    |[DEFAULT]COLLATE[=]collation_name
```
栗子：
```
mysql> create database if not exists mysql_test default character set = gbk;
Query OK, 1 row affected (0.00 sec)
```
[]：表示其内容为可选项；
|： 用于分割花括号中的选项

#### 选择数据库
语法：
```
USE DATABASE_NAME;
```
栗子：
```
mysql> USE mysql_test;
Database changed
```

#### 修改数据库
语法：
```
ALTER {DATABASE|SCHEMA} [db_name]
alter_specification...
```
栗子：
```
mysql> ALTER DATABASE mysql_test
    -> DEFAULT CHARACTER SET gb2312
    -> DEFAULT COLLATE gb2312_chinese_ci;
Query OK, 1 row affected (0.00 sec)
```
#### 删除数据库
语法:
```
DROP {DATABASE|SCHEMA} [IF EXISTS] [db_name]
```
栗子:
```
mysql> DROP DATABASE IF EXISTS mysql_test;
Query OK, 0 rows affected, 1 warning (0.00 sec)
```
#### 查看数据库
语法：
```
SHOW {DATABASES|SCHEMA}
[LIKE 'pattern' | WHERE expr]
```
- LIKE 关键字用于匹配指定的数据库名称
- WHERE 从句用于指定数据库名称查询范围的条件
  
栗子：
```
ysql> SHOW DATABASES;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| mysql              |
| mysql_test         |
| performance_schema |
| study              |
| sys                |
+--------------------+
6 rows in set (0.00 sec)
```

### 表定义

#### 创建表

数据表示关系数据库中最重要的、最基本的数据对象，也是数据存储的基本单位

数据表，被定义为字段的集合，按行和列的格式来存储的，每一行代表一个记录，每一列代表记录中一个字段的取值

CREATE TABLE 语句创建表

主要由：
+ 表创建定义（create definition）
+ 表选项：（table options）
+ 分区选项：（partition options）
  
语法：
```
CREATE [TEMPORARY] TABLE tbl_name
(
    字段名1 数据类型 [列级完整性约束条件][默认值]
    [,字段名2 数据类型 [列级完整性约束条件][默认值]]
    [,表级完整性约束]
)[ENGINT=引擎类型]
```
栗子：
在一个已有的数据库mysql_test中新建一个包含客户姓名、性别、地址、联系方式等内容的客户基本信息表，要求将客户的id号指定为该表的主键
```
mysql> CREATE TABLE customers
    -> (
    -> cust_id int not null auto_increment
    -> ,cust_name varchar(50) not null
    -> ,cust_sex char(1) not null
    -> ,cust_address char(50) null
    -> ,cust_contact char(50) null
    -> ,primary key (cust_id)
    -> );
Query OK, 0 rows affected (0.05 sec)
```

#### 更新表
使用**ALTER TABLE**语句，增加或删减列，创建或取消索引，更改原有列的数据类型，重新命名列或表，更改表的评注和表达引擎类型，为表重新创建触发器、存储过程、索引和外建等。

1. ADD[COLUMN]子句

示例：想数据库mysql_test的表customers中添加一列，并命名为cust_city,要求不能为null，默认值为字符串"Wuhan",且该列位于原表cust_sex列之后。

语法:
```
ALTER TABLE mysql_test.customers
ADD COLUMN cust_city char(10) NOT NULL DEFAULT 'Wuhan' AFTER cust_sex;
```
栗子：
```
mysql> ALTER TABLE mysql_test.customers ADD COLUMN cust_city char(10) NOT NULL DEFAULT 'Wuhan' AFTER cust_sex;
Query OK, 0 rows affected (0.04 sec)
Records: 0  Duplicates: 0  Warnings: 0
```

2. CHANGE[COLUMN]子句 (修改表中列的名称或数据类型)

语法：
```
ALTER TABLE mysql.test.customers
CHANGE COLUMN cust_sex sex char(1) NULL DEFULT 'M';
```
栗子:
```
mysql> ALTER TABLE mysql_test.customers
    -> CHANGE COLUMN cust_sex sex char(2) NULL DEFAULT 'M';
Query OK, 0 rows affected (0.03 sec)
Records: 0  Duplicates: 0  Warnings: 0
```
3. ALTER[COLUMN]子句 修改或删除表中指定列的默认值

语法：
```
ALTER TABLE mysql_test.customers
ALTER COLUMN cust_city SET DEFAULT 'Beijing';
```

栗子：
```
mysql> ALTER TABlE mysql_test.customers ALTER COLUMN cust_city SET DEFAULT 'Beijing';
Query OK, 0 rows affected (0.02 sec)
Records: 0  Duplicates: 0  Warnings: 0
```

4. MODIFY[COLUMN]子句 只修改指定列的数据类型，不会干涉它的列名
语法：
```
ALTER TABLE mysql_test.customers
MODIFY COLUMN cust_name char(20) FIRST;
```
栗子:
```
mysql> ALTER TABLE mysql_test.customers
    -> MODIFY COLUMN cust_name char(11) not null AFTER cust_id;
Query OK, 0 rows affected (0.03 sec)
Records: 0  Duplicates: 0  Warnings: 0
```
   
5. DROP[COLUMN]子句 删除列
语法：
```
mysql> ALTER TABLE mysql_test.customers DROP COLUMN cust_contact;
Query OK, 0 rows affected (0.02 sec)
Records: 0  Duplicates: 0  Warnings: 0
```

6. RENAME[TO]子句 更新表名

语法:
```
ALTER TABLE mysql_test.customers
RENAME TO my_customers;
```

栗子：
```
mysql> ALTER TABLE mysql_test.customers
    -> RENAME TO backup_customers;
Query OK, 0 rows affected (0.00 sec)
```

#### 删除表
语法:
```
DROP[TEMPORANY] TABLE [IF EXISTS] tb_name [,tb_name]
```
栗子：
```
mysql> DROP TABLE IF EXISTS backup_customers;
Query OK, 0 rows affected (0.01 sec)
```

#### 查看表
语法： 
```
SHOW [FULL] COLUMN {FROM | IN} tbl_name [{FROM | IN} db_name] [LIKE 'pattern' | WHERE expr]
```
显示指定数据表的结构
```
{DESCRIBE | DESC} tbl_name [col_name | wild]
```
栗子：

### 索引定义

索引是DBMS根据表中的一列或若干列按照一定顺序建立的列值与记录行之间的对应关系表

索引是提高数据文件访问效率的有效方法

索引存在的弊端：
   1. 索引是以文件的形式存储的，如果有大量的索引，索引文件可能比数据更快达到最大的文件尺寸
   2. 索引在提高查询速度的同时，会降低更新表的速度
+ 普通索引（INDX或KEY）
+ 唯一性索引(UNIQUE)
+ 主键(PRIMARY KEY)

**索引通常被创建成单列索引和组合索引**

#### 索引的创建：（使用CREATE INDEX语句创建）
语法：
```
CREATE [UNIQUE] INDEX index_name 
ON tbl_name(index_col_name...)
```
col_name[(length)][ASC|DESC]

栗子：
```
mysql> CREATE INDEX index_customers
    -> ON mysql_test.customers(cust_name(3) ASC);
Query OK, 0 rows affected (0.02 sec)
```

组合索引栗子：
```
mysql> CREATE INDEX index_cust
    -> ON mysql_test.customers(cust_name, cust_id);
```
索引的创建：使用 CREATE TABLE 语法创建
1. 语法项 [CONSTRAINT[symbol]] PRIMARY KEY(index_col_name, ...),用于表示在创建新表的同时创建该表的主键；
2. 语法项 {INDEX|KEY}[index_name](index_col_name,...),用于表示在创建新表的同时创建该表的索引；
3. 语法项 [CONSTRAINT[symbol]]UNIQUE[INDEX|KEY][index_name](index_col_name,...) 用于表示在创建新表的同时创建该表的唯一性索引
4. 语法项 [CONSTRAINT[symbol]] FOREIGN KEY [index_name](index_col_name, ...),用于表示在创建新表的同时创建该表的外建

栗子:
```
mysql> create table seller
    -> (
    ->     seller_id int not null auto_increment
    ->     ,seller_name char(50) not null
    ->     ,seller_address char(50) null
    ->     ,seller_contact char(50) null
    ->     ,product_type int(5) not null
    ->     ,sales int null
    ->     ,primary key(seller_id, product_type)
    ->     ,index index_seller(sales)
    -> );
Query OK, 0 rows affected (0.02 sec)
```

索引的创建：使用ALTER TABLE语句创建
1. 语法项：ADD {INDEX | KEY} [index_name](index_col_name, ...), 用于表示在修改表的同时为该表添加索引
2. 语法项：ADD [CONSTRAINT [symbol]] PRIMARY KEY (index_col_name,...), 用于表示在创建新表的同时为该表添加主键
3. 语法项：ADD [CONSTRAINT [symbol]] UNIQUE [INDEX | KEY][index_name](index_col_name, ...),用于表示在修改表的同时为该表添加唯一性索引
4. 语法项：ADD [CONSTRAINT [symbol]] FOREIGN KEY (index_col_name,...),用于表示在创建新表的同时为该表添加外建

#### 查看索引（SHOW INDEX）
语法：
```
SHOW {INDEX | INDEXES | KEYS}
{FROM | IN} tbl_name
[{FROM | IN} db_name]
[WHERE expr]
```
栗子：
```
mysql> show index from seller;
+--------+------------+--------------+--------------+--------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| Table  | Non_unique | Key_name     | Seq_in_index | Column_name  | Collation | Cardinality | Sub_part | Packed | Null | Index_type | Comment | Index_comment |
+--------+------------+--------------+--------------+--------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
| seller |          0 | PRIMARY      |            1 | seller_id    | A         |           0 |     NULL | NULL   |      | BTREE      |         |               |
| seller |          0 | PRIMARY      |            2 | product_type | A         |           0 |     NULL | NULL   |      | BTREE      |         |               |
| seller |          1 | index_seller |            1 | sales        | A         |           0 |     NULL | NULL   | YES  | BTREE      |         |               |
+--------+------------+--------------+--------------+--------------+-----------+-------------+----------+--------+------+------------+---------+---------------+
3 rows in set (0.00 sec)
```

#### 删除索引：使用DROP INDEX语句
语法：
```
DROP INDEX index_cust ON mysql_test.customers;
```

栗子：
```
mysql> drop index index_cust ON customers;
Query OK, 0 rows affected (0.02 sec)
```
#### 使用ALTER TABLE语句删除
1. 选用 DROP PRIMARY KEY 子句用于删除表中的主键，由于一个表中只有一个主键，其也是一个索引
2. 选用DROP INDEX子句用于删除各种类型的索引
3. 选用DROP FOREIGN KEY 子句用于删除外建

栗子:
```
ALTER TABLE T_NAME
DROP PRIMARY KEY
,DROP INDEX INDEX_NAME
,DROP FOREIGN KEY
```
## 数据更新

### 插入数据
语法:
```
INSERT [INSERT] tbl_name [(col_name,...)]
{VALUES | VALUE} ({expr | DEFAULT},...),(...)...
```
栗子：
```
mysql> insert into customers(cust_id, cust_name, cust_sex, cust_address, cust_contact) values (901, '张三', 'F', '北京市', '朝阳区');
Query OK, 1 row affected (0.02 sec)
```

使用INSERT ... SET 语句插入部分列值数据

使用INSERT ...SELECT语句插入子查询数据
### 删除数据

使用DELETE语句删除一行或多行数据
### 修改数据

使用UPDATE语句修改更新一个表中的数据

## 数据查询

### SELECT语句
语法：
```
SELECT [ALL | DISTINCT | DISTINCTROW]
select_expr [, select_expr ...]
FROM tbl_name
[WHERE where_condition]
[GROUP BY {col_name|expr|position}
[ASC|DESC],...[WITH ROLLUP]]
[HAVING where_condition]
[ORDER BY {col_name | expr | position} [ASC | DESC],...]
[LIMIT {[offset,]row_count | row_count OFFSET offset]
```

|子句|说明|是否必须使用|
|:--|:--|:--:|
|SELECT|要返回的列或表达式|是|
|FROM|从中检索数据的表|仅在从表选择数据时使用|
|WHERE|行级过滤|否|
|GROUP BY|分组说明|仅在按组计算聚合时使用|
|HAVING|组级过滤|否|
|ORDER BY|输出排序顺序|否|
|LIMIT|要检索的函数|否|

### 列的选择与指定
1. 查询指定列 SELECT col_name1,col_name2 FROM tbl_name
2. 查询所有列 SELECT * FROM tbl_name
3. 定义并使用列的别名 SELECT cust_name as 地址 from customers;
4. 替换查询结果集中的数据

```
CASE 
WHEN 条件1 THEN 表达式1 
WHEN 条件2 THEN 表达式2
....
ELSE 表达式
END [AS] column_alias
```

例:
```
mysql> SELECT cust_name, CASE WHEN cust_sex = 'm' THEN '男' ELSE '女' END AS 性别 FROM customers;
+-----------+--------+
| cust_name | 性别   |
+-----------+--------+
| 哇哈哈    | 男     |
+-----------+--------+
```

计算列值
```
mysql> SELECT cust_id + 100, cust_name, cust_sex FROM customers;
+---------------+-----------+----------+
| cust_id + 100 | cust_name | cust_sex |
+---------------+-----------+----------+
|           101 | 哇哈哈    | m        |
+---------------+-----------+----------+
```

聚合函数：通常是数据库系统中一类系统 **内置函数**
|函数名|说明|
|:--|:--|
|COUNT|求组中项数，返回INT类型整数|
|MAX|求最大值|
|MIN|求最小值|
|SUM|返回表达式中所有值的和|
|AVG|求组中值的平均值|
|STD或STDDEV|返回给定表达式中所有值的标准值|
|VARIANC|返回给定表达式中所有值的方差|
|GROUP_CONTACT|返回由属于一组的列值连接组合而成的结果|
|BIT_AND|逻辑或|
|BIR_OR|逻辑与|
|BIT_XOR|逻辑异或|

### FROM子句与多表连接查询

#### 交叉连接，又称笛卡尔积
语法：
```
SELECT * FROM tbl1 CROSS JOIN tbl2;
OR
SELECT * FROM tbl1, tbl2;
```

栗子：
```
mysql> select * from tbl1 cross join tbl2;
mysql> select * from tbl1,tbl2;
```
#### 内连接
语法
```
SELECT some_columns FROM table1 INNER JOIN table2 ON some_conditions;
```
栗子:
```

```
1. 等值连接：使用运算符=
2. 非等值连接：使用除=之外的其他比较运算符
3. 自然连接：将一个表与他自身进行连接

#### 外链接
1. 左外链接：在FROM子句中使用关键字LEFT OUTER JOIN 或 LEFT JOIN
2. 右外链接：在FROM子句中使用关键字RIGHT OUTER JOIN 或 RIGHT JOIN

简述左外连接和右外连接的区别

左外链接：也称左连接。以左表为基表，在FROM子中使用关键字“LEFT OUTER JOIN”或关键字 “LEFT JOIN” 来连接两张表。
右外连接：也称右连接。以右表为基表，在FROM子句中使用关键字“RIGHT OUTER JOIN”或关键字“RIGHT JOIN”来连接两张表

### WHERE子句与条件查询

比较运算符


|比较运算符|说明|
|:--|:--|
|=|等于|
|<>|不等于|
|!=|不等于|
|<|小于|
|<=|小于等于|
|>|大于|
|>=|大于等于|
|<=>|不会返回UNKNOWN|

判断范围

当查询的过滤条件被限定在值的某个范围时，可以使用关键字“BETWEEN”
语法：
```
SELECT * FROM customers WHERE cust_id BETWEEN 1 AND 2;
```

使用关键字“IN”可以指定一个值的枚举表，该表中会列举所有可能的值
语法：
```
SELECT * FRON customers WHERE cust_id in (1,2,3,4,5);
```

判定空值
语法：
```
SELECT * FROM customers WHERE cust_contact is null;
```

IN,ANY,SOME

NOT IN , <>ALL


```
SELECT * FROM tb_name WHERE col_name {IN|ANY|SOME} (1,2,3)
```

**子查询-结合关键字 “EXIST”使用的子查询**

子查询的结果集不为空，则返回TRUE，否则返回FALSE
```
SELECT * FROM customers WHERE EXISTS (SELECT * FROM customers);

SELECT * FROM customers WHERE NOT EXISTS (SELECT * FROM customers);
```

### GROUP BY 子句

```
SELECT * FROM customers GROUP BY {col_name | position}[ASC | DESC],...[WITH ROLLUP]
```

指定在结果集中不仅包含由GROUP BY 子句分组后的数据行，还包括各分组的汇总行，以及所有分组的整行汇总行，可以得到每个分组以及每个分组汇总级别的值 

### HAVING 子句
```
HAVING WHERE_COINDITION
```

|HAVING子句 |WHERE子句|
|--|--|
|过滤分组|过滤数据行|
|可以包含聚合函数|不可以包含聚合函数|
|在数据分组后进行过滤|在数据分组前过滤|

### ORDER BY 子句
```
ORDER BY {col_nae expr | position}[AC | DESC],...
```

|ORDER BY| GROUP BY|
|--|--|
|排序产生的输出|分组行，但输出可能不是分组的排序|
|任意列都可以使用|只可能使用选择列或表达式|
|不一定需要|若聚合函数一起使用列或表达式，则必须使用|

### LIMIT子句
**使用LIMIT子句限制被SELECT语句返回的行数**
```
LIMIT {[offset,] row_count | row_count OFFSET OFFSET}
```
栗子：
```
SELECT * FROM customers LIMIT 1,2;

SELECT * FROM customers 2 OFFSET 1;
```
## 视图
### 什么是视图
视图是数据库中的一个对象，它是数据库管理系统提供给用户的以多种角度观察数据库中数据的一种重要机制

视图不是数据库中真实的表，而是一张虚拟表，其自身并不存在
### 使用视图的优点
+ 集中分散数据
+ 简化查询语句
+ 重用SQL语句
+ 保护数据安全
+ 共享所需数据
+ 更改数据格式
### 创建视图
```
CREATEVIEW view_name[(column_list)]
AS select_statement
[WITH [CASCADED | LOCAL] CHECK OPTION]
```

指定在可更新视图上所进行的修改都需要复符合select_statement中所指定的限制条件


### 删除视图

```
drop view [if exists] view_name [,view_name]...
```

### 修改视图定义

```
ALTERVIEW view_name [(column_list)]
AS select_statement
[WITH [CASCADED | LOCAL] CHECK OPTION]
```

### 查看视图定义
```
SHOW CREATE VIEW view_name
```

### 更新视图数据
```
INSERT INTO customers_view VALUES (NULL, '农夫山泉', 'm', '北京', '有点甜');
```

**使用UPDATE语句通过视图修改基本表的数据**
```
UPDATE customers_view SET cust_address = '湖北' WHERE cust_name = '农夫山泉';
```

**使用DELETE语句通过视图删除基本表的数据**
```
DELETE FROM customers_view WHERE cust_name = '农夫山泉';
```

### 查询数据视图
```
SELECT * FROM customers_view;
````